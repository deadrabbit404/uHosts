#!/system/bin/sh

# Directory where hosts file is located
HOSTSDIR="/data/adb/modules/hosts/system/etc"

# Path to hosts file
HOSTSFILE="$HOSTSDIR/hosts"

# Variable for determining which variant to update
ACTIVE_VARIANT=""

# Set colors
R="\e[1;31m"    # Red
G="\e[1;32m"    # Green
Y="\e[1;33m"    # Yellow
N="\e[0m"       # No color

show_banner () {
    clear
    echo -e "$R"
    cat << 'EOF'
        _   _           _
       | | | |         | |
  _   _| |_| | ___  ___| |_ ___
 | | | |  _  |/ _ \/ __| __/ __|
 | |_| | | | | (_) \__ \ |_\__ \
  \__,_\_| |_/\___/|___/\__|___/ v0.2-rc1
EOF
echo -e "$Y  by: deadrabbit404@GitHub$N\n"
}

main_menu () {
    show_banner
    check_status
    echo -e "\nSelect one of the options below\n"
    echo -e "(Variants)"
    echo -e "  [${Y}m$N] mini"
    echo -e "  [${Y}l$N] Lite (recommended)"
    echo -e "  [${Y}p$N] Pro"
    echo -e "  [${Y}x$N] Xtra"
    echo -e "\n(Other options)"
    echo -e "  [${Y}u$N] Update current variant"
    echo -e "  [${Y}s$N] Show description for each variant"
    echo -e "  [${Y}f$N] Fallback to system default hosts"
    echo -e "  [${Y}q$N] Quit"
}

verify_systemless_hosts () {
# Check if systemless host is enabled in Magisk
    if [ ! -d "$HOSTSDIR" ]
    then
        echo -e "$R[Ã—] Systemless hosts is disabled.$N"
        echo -e "    - Enable it via Magisk>Settings>Systemless hosts"
        echo -e "    - Reboot and re-run the script"
        exit 1
    fi
}

check_status () {
# Check if your device is using one of the variants
# and print the active variant on the screen
    variant=`grep "Title:" $HOSTSFILE | awk -F'(' '{ print $2 }' | grep -oE '[a-zA-Z]+'`
    sleep 0.5

    if [ -z "$variant" ]
    then
        # Set ACTIVE_VARIANT to empty string
        ACTIVE_VARIANT=""
        # Interpolate with red color
        variant="${R}N/A$N"
        echo -e "Status: ${R}Unprotected$N"

    else
        # Update ACTIVE_VARIANT
        ACTIVE_VARIANT=$variant
        # Interpolate with green color
        variant="$G$variant$N"
        echo -e "Status: ${G}Protected$N"
    fi

    echo -e "Active variant: $variant"
    sleep 0.5
}

show_variants () {
# Show description for each variant
    show_banner
    echo -e "Available variants:\n"
    echo -e "  ${G}mini$N - lenient; unblocks a number of ads & trackers for in-app rewards"
    echo -e "  ${G}Lite$N - balanced; doesn't hamper user experience (UX), recommended"
    echo -e "  ${G}Pro$N  - strict; prioritizes privacy & safety (adblocking) over UX"
    echo -e "  ${G}Xtra$N - extremely aggressive & restrictive"
    echo -e "\nPress Enter to return to main menu"
    read choice
}

download () {
# Download chosen variant and set it as the hosts file
    rhost="o0.pages.dev"
    remote_file="https://$rhost/$1/hosts.txt"
    show_banner
    echo -e "Downloading $1 variant..."
    sleep 0.5
    wget --no-check-certificate $remote_file -O $HOSTSFILE

    if [ $? -eq 0 ]
    then
        echo -e "\n${G}Download complete$N"
    else
        echo -e "\n${R}Error: Download failed!$N\n"
    fi

    echo -e "Press Enter to return to main menu "
    read choice

}

update () {
# Update current hosts variant but only if there is one
    if [ ! -z "$ACTIVE_VARIANT" ]
    then
        show_banner
        echo -e "Updating hosts file..."
        sleep 1
        download $ACTIVE_VARIANT
    else
        echo -e "\n${R}You are not using any of the variants!$N"
        sleep 2
    fi
}

restore_default () {
# Restore the default hosts file
    show_banner
    echo -e "Reverting back to default hosts..."
    sleep 1
    echo -e "127.0.0.1\tlocalhost" > $HOSTSFILE
    echo -e "::1\t\tip6-localhost" >> $HOSTSFILE
    echo -e "Done"
}

# Exit immediately if not root
if [ `id -u` -ne 0 ]
then
    echo -e "${R}You are not root!$N"
    exit 1
fi

verify_systemless_hosts

while true
do
    main_menu
    echo -en "\nSelect: "
    read choice

    case $choice in
        [mM])
            download "mini"
            ;;
        [lL])
            download "Lite"
            ;;
        [pP])
            download "Pro"
            ;;
        [xX])
            download "Xtra"
            ;;
        [fF])
            restore_default
            ;;
        [sS])
            show_variants
            ;;
        [uU])
            update
            ;;
        [qQ])
            exit 0
	        ;;
        *)
            echo -en "${R}Are you blind bruh?$N"
            sleep 2
            ;;
    esac
done
